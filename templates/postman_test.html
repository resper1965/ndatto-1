{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-cloud-arrow-up me-2"></i>
                Teste de APIs do Postman
            </h2>
            <p class="text-muted">Teste as APIs da Datto RMM via Postman Collection</p>
        </div>
    </div>

    <!-- Cards de Teste -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card dashboard-card">
                <div class="card-body text-center">
                    <i class="bi bi-building icon-large mb-3"></i>
                    <h5 class="card-title">Sites API</h5>
                    <p class="card-text">Teste a API de Sites</p>
                    <button class="btn btn-primary" onclick="testSitesAPI()">
                        <i class="bi bi-play me-2"></i>Testar Sites
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card dashboard-card">
                <div class="card-body text-center">
                    <i class="bi bi-pc-display icon-large mb-3"></i>
                    <h5 class="card-title">Devices API</h5>
                    <p class="card-text">Teste a API de Devices</p>
                    <button class="btn btn-primary" onclick="testDevicesAPI()">
                        <i class="bi bi-play me-2"></i>Testar Devices
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card dashboard-card">
                <div class="card-body text-center">
                    <i class="bi bi-exclamation-triangle icon-large mb-3"></i>
                    <h5 class="card-title">Alerts API</h5>
                    <p class="card-text">Teste a API de Alerts</p>
                    <button class="btn btn-primary" onclick="testAlertsAPI()">
                        <i class="bi bi-play me-2"></i>Testar Alerts
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-code-slash me-2"></i>
                        Resultados dos Testes
                    </h5>
                </div>
                <div class="card-body">
                    <div id="results">
                        <p class="text-muted text-center">Clique em um botão acima para testar as APIs</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- URLs do Postman -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-link-45deg me-2"></i>
                        URLs para Postman
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Sites API</h6>
                            <code class="d-block p-2 bg-light rounded">
                                GET /api/postman/sites
                            </code>
                        </div>
                        <div class="col-md-4">
                            <h6>Devices API</h6>
                            <code class="d-block p-2 bg-light rounded">
                                GET /api/postman/devices
                            </code>
                        </div>
                        <div class="col-md-4">
                            <h6>Alerts API</h6>
                            <code class="d-block p-2 bg-light rounded">
                                GET /api/postman/alerts
                            </code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function testSitesAPI() {
    showLoading('Testando Sites API...');
    try {
        const response = await fetch('/api/postman/sites');
        const data = await response.json();
        showResults('Sites API', data);
    } catch (error) {
        showError('Erro ao testar Sites API: ' + error.message);
    }
}

async function testDevicesAPI() {
    showLoading('Testando Devices API...');
    try {
        const response = await fetch('/api/postman/devices');
        const data = await response.json();
        showResults('Devices API', data);
    } catch (error) {
        showError('Erro ao testar Devices API: ' + error.message);
    }
}

async function testAlertsAPI() {
    showLoading('Testando Alerts API...');
    try {
        const response = await fetch('/api/postman/alerts');
        const data = await response.json();
        showResults('Alerts API', data);
    } catch (error) {
        showError('Erro ao testar Alerts API: ' + error.message);
    }
}

function showLoading(message) {
    document.getElementById('results').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">${message}</p>
        </div>
    `;
}

function showResults(apiName, data) {
    const resultsDiv = document.getElementById('results');
    
    if (data.status === 'success') {
        let html = `
            <div class="alert alert-success">
                <h6><i class="bi bi-check-circle me-2"></i>${apiName} - Sucesso!</h6>
                <small class="text-muted">Fonte: ${data.source} | Timestamp: ${data.timestamp}</small>
            </div>
            <h6>Dados Recebidos:</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
        `;
        
        // Cria cabeçalhos dinâmicos
        if (data.data && data.data.length > 0) {
            const headers = Object.keys(data.data[0]);
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Adiciona dados
            data.data.forEach(item => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${item[header] || '-'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
        }
        
        html += `
            <div class="mt-3">
                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${JSON.stringify(data, null, 2)}')">
                    <i class="bi bi-clipboard me-2"></i>Copiar JSON
                </button>
            </div>
        `;
        
        resultsDiv.innerHTML = html;
    } else {
        showError(`${apiName} - Erro: ${data.message}`);
    }
}

function showError(message) {
    document.getElementById('results').innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('JSON copiado para a área de transferência!');
    });
}
</script>
{% endblock %} 